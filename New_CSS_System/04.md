Perplexity correctly identified three issues we need to fix. Here are the corrected versions:

## Fixed Step 3: Layout & Anti-Shift Measures

### Corrected Reset with Font Metrics

**Update `src/assets/css/0-critical/reset-and-base.css`:**

```css
@layer reset {
  /* Prevent scrollbar layout shift */
  html {
    overflow-y: scroll; /* Fallback */
  }
  
  @supports (scrollbar-gutter: stable) {
    html {
      overflow-y: auto;
      scrollbar-gutter: stable;
    }
  }
  
  /* Box sizing */
  *, *::before, *::after {
    box-sizing: border-box;
  }
  
  * {
    margin: 0;
  }
  
  /* Apply system font WITH the metrics */
  body {
    font-family: system-ui, -apple-system, 'Segoe UI', sans-serif;
    line-height: 1.5;
    min-height: 100vh;
    background: var(--color-surface);
    color: var(--color-text);
    
    /* Font metrics to prevent CLS */
    font-synthesis: none;
    text-rendering: optimizeLegibility;
  }
  
  /* Context-specific image placeholders */
  article img:not([width]):not([height]) {
    aspect-ratio: 3/2; /* More neutral for article images */
  }
  
  .avatar:not([width]):not([height]) {
    aspect-ratio: 1; /* Square for avatars */
  }
  
  /* Rest of your reset stays the same... */
}
```

### Corrected Container Queries

**Update `src/assets/css/2-layout/containers.css`:**

```css
@layer layout {
  /* Container wrapper for query context */
  .container-wrapper {
    container-type: inline-size;
    container-name: wrapper;
  }
  
  /* The actual container */
  .container {
    --container-padding: var(--space-md);
    width: 100%;
    max-width: var(--container-max, 65ch);
    margin-inline: auto;
    padding-inline: var(--container-padding);
  }
  
  /* Container query targets CHILDREN of container */
  @container wrapper (width > 600px) {
    .container {
      --container-padding: var(--space-lg);
    }
    
    .stack {
      --stack-gap: var(--space-lg);
    }
  }
  
  /* Alternative: unnamed container queries */
  .responsive-grid {
    container-type: inline-size;
  }
  
  @container (width > 500px) {
    .responsive-grid > * {
      /* This targets children */
      grid-column: span 6;
    }
  }
  
  /* Rest stays the same... */
}
```

## Step 4: Enhanced Components & Utilities

Create **`src/assets/css/3-components/buttons.css`:**

```css
@layer components {
  /* Button variants using data attributes */
  button,
  .button {
    /* Base button styles */
    display: inline-flex;
    align-items: center;
    justify-content: center;
    padding: var(--space-xs) var(--space-md);
    font-weight: var(--font-medium);
    border-radius: 6px;
    border: 1px solid transparent;
    cursor: pointer;
    transition: transform 0.2s, box-shadow 0.2s;
    
    /* Default variant */
    background: var(--color-primary);
    color: var(--color-surface);
  }
  
  button:hover,
  .button:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 12px oklch(from var(--color-primary) l c h / 0.2);
  }
  
  button:active,
  .button:active {
    transform: translateY(0);
  }
  
  /* Secondary variant */
  button[data-variant="secondary"],
  .button[data-variant="secondary"] {
    background: var(--color-surface-elevated);
    color: var(--color-text);
    border-color: var(--color-border);
  }
  
  /* Ghost variant */
  button[data-variant="ghost"],
  .button[data-variant="ghost"] {
    background: transparent;
    color: var(--color-primary);
    border-color: currentColor;
  }
  
  /* Size variants */
  button[data-size="small"],
  .button[data-size="small"] {
    padding: var(--space-2xs) var(--space-sm);
    font-size: var(--text-sm);
  }
  
  button[data-size="large"],
  .button[data-size="large"] {
    padding: var(--space-sm) var(--space-lg);
    font-size: var(--text-lg);
  }
  
  /* Disabled state */
  button:disabled {
    opacity: 0.5;
    cursor: not-allowed;
    transform: none !important;
  }
}
```

Create **`src/assets/css/3-components/cards.css`:**

```css
@layer components {
  @scope (.card) {
    :scope {
      background: var(--color-surface-elevated);
      border: 1px solid var(--color-border);
      border-radius: 12px;
      padding: var(--space-md);
      box-shadow: 0 1px 3px oklch(0% 0 0 / 0.04);
      
      /* Enable container queries for responsive cards */
      container-type: inline-size;
    }
    
    /* Card sections */
    .card-header {
      margin-block-end: var(--space-md);
      padding-block-end: var(--space-md);
      border-block-end: 1px solid var(--color-border);
    }
    
    .card-title {
      font-size: var(--text-xl);
      font-weight: var(--font-semibold);
      line-height: var(--leading-tight);
    }
    
    .card-content {
      color: var(--color-text-secondary);
    }
    
    .card-footer {
      margin-block-start: var(--space-md);
      padding-block-start: var(--space-md);
      border-block-start: 1px solid var(--color-border);
    }
    
    /* Responsive behavior */
    @container (width > 400px) {
      :scope {
        padding: var(--space-lg);
      }
    }
  }
  
  /* Card grid helper */
  .card-grid {
    display: grid;
    gap: var(--space-md);
    grid-template-columns: repeat(auto-fill, minmax(min(300px, 100%), 1fr));
  }
}
```

Create **`src/assets/css/4-utilities/utilities.css`:**

```css
@layer utilities {
  /* Text utilities */
  .text-balance {
    text-wrap: balance;
  }
  
  .text-center {
    text-align: center;
  }
  
  .text-muted {
    color: var(--color-text-secondary);
  }
  
  /* Spacing utilities */
  .mt-auto { margin-block-start: auto; }
  .mb-0 { margin-block-end: 0; }
  
  /* Display utilities */
  .hidden {
    display: none !important;
  }
  
  @media (width >= 768px) {
    .hidden-desktop {
      display: none !important;
    }
  }
  
  @media (width < 768px) {
    .hidden-mobile {
      display: none !important;
    }
  }
  
  /* Visual utilities */
  .sr-only {
    position: absolute;
    width: 1px;
    height: 1px;
    padding: 0;
    margin: -1px;
    overflow: hidden;
    clip: rect(0, 0, 0, 0);
    white-space: nowrap;
    border-width: 0;
  }
  
  /* Loading states */
  .skeleton {
    background: linear-gradient(
      90deg,
      var(--color-border) 25%,
      var(--color-surface-elevated) 50%,
      var(--color-border) 75%
    );
    background-size: 200% 100%;
    animation: skeleton-loading 1.5s infinite;
    border-radius: 6px;
  }
  
  @keyframes skeleton-loading {
    0% { background-position: 200% 0; }
    100% { background-position: -200% 0; }
  }
}
```

## Updated Main.css

```css
/* Define layer order */
@layer reset, tokens, layout, components, utilities;

/* Critical imports */
@import "0-critical/reset-and-base.css" layer(reset);

/* Tokens */
@import "1-tokens/colors.css" layer(tokens);
@import "1-tokens/spacing.css" layer(tokens);
@import "1-tokens/typography.css" layer(tokens);

/* Layout */
@import "2-layout/containers.css" layer(layout);
@import "2-layout/view-transitions.css" layer(layout);

/* Components */
@import "3-components/forms.css" layer(components);
@import "3-components/buttons.css" layer(components);
@import "3-components/cards.css" layer(components);

/* Utilities */
@import "4-utilities/utilities.css" layer(utilities);
```

## Test HTML for New Components

```html
<!-- Test in src/component-test.html -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="color-scheme" content="light dark">
  <title>Component Test</title>
  
  <script>
    const t = localStorage.getItem('theme');
    if (t) document.documentElement.dataset.theme = t;
  </script>
  
  <link rel="stylesheet" href="/assets/css/main.css">
</head>
<body>
  <div class="container-wrapper">
    <div class="container">
      <h1 class="text-balance">Component Library</h1>
      
      <section class="stack">
        <h2>Buttons</h2>
        <div class="cluster">
          <button>Default</button>
          <button data-variant="secondary">Secondary</button>
          <button data-variant="ghost">Ghost</button>
          <button data-size="small">Small</button>
          <button data-size="large">Large</button>
          <button disabled>Disabled</button>
        </div>
      </section>
      
      <section class="stack">
        <h2>Cards</h2>
        <div class="card-grid">
          <article class="card">
            <div class="card-header">
              <h3 class="card-title">Card Title</h3>
            </div>
            <div class="card-content">
              <p>Card content with secondary text color.</p>
            </div>
            <div class="card-footer">
              <button data-variant="ghost" data-size="small">Action</button>
            </div>
          </article>
          
          <article class="card">
            <h3 class="card-title">Simple Card</h3>
            <p>Cards work with or without sections.</p>
          </article>
        </div>
      </section>
      
      <section class="stack">
        <h2>Loading States</h2>
        <div class="skeleton" style="height: 2rem; width: 200px;"></div>
        <div class="skeleton" style="height: 4rem;"></div>
      </section>
    </div>
  </div>
</body>
</html>
```

The key fixes from Perplexity's feedback:
1. **Container queries** now properly target children, not the container itself
2. **Font metrics** are applied directly in body, not in a separate @font-face
3. **Image placeholders** are context-specific, not global 16:9

Test this setup - the components should work well with your classless base, and view transitions should work when navigating between pages.